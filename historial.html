<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Profesional de Vuelos</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family:'Roboto', sans-serif;
    background:#eef2f7;
    color:#1a1a1a;
    padding:20px;
    transition: background 0.3s, color 0.3s;
  }
  h1 {
    text-align:center;
    color:#0f254d;
    margin-bottom:10px;
    font-weight:700;
    letter-spacing:1px;
  }
  .top-bar {
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    margin-bottom:15px;
  }
  .top-bar .contadores {
    text-align:right;
    display:flex;
    gap:15px;
    flex-wrap:wrap;
  }
  .top-bar .contador {
    background:#0f254d;
    color:#eaf2ff;
    padding:10px 15px;
    border-radius:10px;
    font-weight:500;
    box-shadow:0 3px 10px rgba(0,0,0,0.1);
    transition: background 0.3s, color 0.3s;
  }
  .mode-btn {
    padding:10px 20px;
    background:#0f254d;
    color:#eaf2ff;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-size:16px;
    font-weight:600;
    transition: background 0.3s, color 0.3s;
  }
  .table-container {
    max-width:1200px;
    margin:0 auto;
    background:#fff;
    border-radius:12px;
    box-shadow:0 6px 20px rgba(0,0,0,0.12);
    overflow:hidden;
    transition: background 0.3s;
  }
  .filter-container {
    padding:15px 20px;
    background:#0f254d;
    display:flex;
    align-items:center;
    gap:10px;
    transition: background 0.3s;
  }
  .filter-container input {
    width:100%;
    padding:12px 14px;
    border-radius:8px;
    border:none;
    outline:none;
    font-size:16px;
    font-weight:500;
  }
  .table-scroll {
    max-height:500px;
    overflow-y:auto;
  }
  table {
    width:100%;
    border-collapse:collapse;
    font-weight:500;
    transition: color 0.3s, background 0.3s;
  }
  thead {
    position:sticky;
    top:0;
    z-index:2;
    cursor:pointer;
    transition: background 0.3s, color 0.3s;
  }
  th, td {
    padding:14px 12px;
    text-align:center;
    border-bottom:1px solid #ddd;
    transition: background 0.3s, color 0.3s;
    font-size:15px;
  }
  th {
    background-color:#0f254d;
    color:#eaf2ff;
    font-weight:700;
    letter-spacing:0.5px;
    position:relative;
  }
  th .material-icons {
    font-size:16px;
    vertical-align:middle;
    margin-left:5px;
    opacity:0.7;
  }
  tr:nth-child(even) { background-color:#f2f5f9; }
  tbody tr:hover { background-color:#cde0f7; }
  .loading { text-align:center; font-style:italic; color:#666; }
  td:nth-child(1) { color:#1a237e; font-weight:500; }
  td:nth-child(2) { color:#00695c; }
  td:nth-child(3) { color:#b71c1c; }
  td:nth-child(4) { color:#f57f17; }
  td:nth-child(5) { color:#4a148c; }

  /* Modo noche */
  body.night {
    background:#0a1e3c;
    color:#e0eafc;
  }
  body.night h1 { color:#cfdfff; }
  body.night .table-container { background:#0e1b36; }
  body.night .filter-container { background:#13244d; }
  body.night .mode-btn { background:#1f3570; color:#eaf2ff; }
  body.night thead { background-color:#1a2c59; color:#cfdfff; }
  body.night tr:nth-child(even) { background-color:#11203b; }
  body.night tbody tr:hover { background-color:#1e3a70; }
  body.night td:nth-child(1) { color:#a5c3ff; }
  body.night td:nth-child(2) { color:#66ffcc; }
  body.night td:nth-child(3) { color:#ff8a80; }
  body.night td:nth-child(4) { color:#ffe57f; }
  body.night td:nth-child(5) { color:#d1a3ff; }
  body.night .loading { color:#aaa; }
  body.night .top-bar .contador { background:#1f3570; color:#cfdfff; }

  @media(max-width:768px){
    th, td { font-size:13px; padding:10px 6px; }
    .filter-container input { font-size:14px; }
    .top-bar { flex-direction:column; align-items:flex-start; }
    .top-bar .contadores { margin-top:10px; }
  }
</style>
</head>
<body>

<div class="top-bar">
  <button class="mode-btn" id="toggleMode">Modo Noche</button>
  <div class="contadores" id="contadores">
    <div class="contador" id="vuelosDia">Vuelos hoy: 0</div>
    <div class="contador" id="vuelosMes">Vuelos este mes: 0</div>
    <div class="contador" id="vuelosAnio">Vuelos este año: 0</div>
    <div class="contador" id="usuariosActivos">Usuarios activos: 0</div>
  </div>
</div>

<div class="table-container">
  <div class="filter-container">
    <span class="material-icons">search</span>
    <input type="text" id="busqueda" placeholder="Filtrar por cualquier columna...">
  </div>
  <div class="table-scroll">
    <table id="tablaVuelos">
      <thead>
        <tr>
          <th data-column="Fecha">Fecha <span class="material-icons"></span></th>
          <th data-column="Escala">Escala <span class="material-icons"></span></th>
          <th data-column="Matricula">Matricula <span class="material-icons"></span></th>
          <th data-column="LLegada Numero Vuelo">LLegada Numero Vuelo <span class="material-icons"></span></th>
          <th data-column="Salida Numero Vuelo">Salida Numero Vuelo <span class="material-icons"></span></th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="5" class="loading">Cargando datos...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const urlVuelos = "https://script.google.com/macros/s/AKfycbzHBAOf8dQrIiWr0cfk_0cD3WOJ92iHlP7xW59WmkKcjB0zYfL_oiB8wD6gcXgokJ0O/exec";
const urlUsuarios = "https://script.google.com/macros/s/AKfycbyDlS9DwwsXMk2DCV6fi-BGix0Qi5P4Lk4if_Vc0wh5xIFqqXCBtg2zQnCgtrTitbc/exec";
const tbody = document.querySelector("#tablaVuelos tbody");
const inputFiltro = document.getElementById("busqueda");
const toggleBtn = document.getElementById("toggleMode");
const bodyEl = document.body;
let tablaData = [];

// Generar SessionID aleatorio para el usuario
const sessionId = '_' + Math.random().toString(36).substr(2, 9);

function formatFecha(fechaStr){
  if(!fechaStr) return "";
  const date = new Date(fechaStr);
  if(isNaN(date)) return fechaStr;
  const dd = String(date.getDate()).padStart(2,"0");
  const mm = String(date.getMonth()+1).padStart(2,"0");
  const yyyy = date.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
}

function actualizarContadores(){
  const hoy = new Date();
  const dia = hoy.toDateString();
  const mes = hoy.getMonth();
  const anio = hoy.getFullYear();

  const vuelosHoy = tablaData.filter(f=>new Date(f.Fecha).toDateString()===dia).length;
  const vuelosMes = tablaData.filter(f=>new Date(f.Fecha).getMonth()===mes && new Date(f.Fecha).getFullYear()===anio).length;
  const vuelosAnio = tablaData.filter(f=>new Date(f.Fecha).getFullYear()===anio).length;

  document.getElementById("vuelosDia").textContent = `Vuelos hoy: ${vuelosHoy}`;
  document.getElementById("vuelosMes").textContent = `Vuelos este mes: ${vuelosMes}`;
  document.getElementById("vuelosAnio").textContent = `Vuelos este año: ${vuelosAnio}`;
}

// Renderizar tabla
function renderTabla(data){
  tbody.innerHTML="";
  if(!data || data.length===0){
    tbody.innerHTML=`<tr><td colspan="5">No hay datos disponibles</td></tr>`;
    return;
  }
  data.forEach(fila=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${formatFecha(fila["Fecha"])}</td>
      <td>${fila["Escala"]||""}</td>
      <td>${fila["Matricula"]||""}</td>
      <td>${fila["LLegada Numero Vuelo"]||""}</td>
      <td>${fila["Salida Numero Vuelo"]||""}</td>
    `;
    tbody.appendChild(tr);
  });
  actualizarContadores();
}

// Fetch datos de vuelos
fetch(urlVuelos)
.then(res=>res.json())
.then(data=>{
  tablaData=data;
  renderTabla(tablaData);
})
.catch(err=>{
  console.error(err);
  tbody.innerHTML=`<tr><td colspan="5">Error al cargar los datos</td></tr>`;
});

// Filtro
inputFiltro.addEventListener("input",()=>{
  const val=inputFiltro.value.toLowerCase();
  const filtrado=tablaData.filter(f=>Object.values(f).some(v=>String(v).toLowerCase().includes(val)));
  renderTabla(filtrado);
});

// Ordenamiento
document.querySelectorAll("th").forEach(th=>{
  th.addEventListener("click",()=>{
    const col=th.getAttribute("data-column");
    const isAsc=th.classList.contains("asc");
    document.querySelectorAll("th").forEach(h=>h.classList.remove("asc","desc"));
    th.classList.toggle(isAsc?"desc":"asc");
    tablaData.sort((a,b)=>{
      let va=a[col]||"", vb=b[col]||"";
      if(col==="Fecha"){ va=new Date(va); vb=new Date(vb);}
      return (va>vb?1:(va<vb?-1:0)) * (isAsc?-1:1);
    });
    renderTabla(tablaData);
  });
});

// Modo noche/día
toggleBtn.addEventListener("click",()=>{
  bodyEl.classList.toggle("night");
  toggleBtn.textContent = bodyEl.classList.contains("night") ? "Modo Día" : "Modo Noche";
});

// ----- USUARIOS ACTIVOS -----
function actualizarUsuarioActivo() {
  fetch(urlUsuarios, {
    method: "POST",
    body: JSON.stringify({sessionId}),
  }).catch(err => console.error(err));
}

function obtenerUsuariosActivos(){
  fetch(urlUsuarios)
  .then(res=>res.json())
  .then(data=>{
    document.getElementById("usuariosActivos").textContent = `Usuarios activos: ${data.activos}`;
  });
}

// Ciclo cada 10s
actualizarUsuarioActivo();
obtenerUsuariosActivos();
setInterval(()=>{
  actualizarUsuarioActivo();
  obtenerUsuariosActivos();
},10000);
</script>

</body>
</html>
